<!DOCTYPE html>
<meta charset="utf-8">
<link type="text/css" rel="stylesheet" href="style/general.css"/>
<link type="text/css" href="style/jquery-ui-1.8.20.custom.css" rel="stylesheet"/>
<script src="script/d3.v2.js"></script>
<script src="script/jquery-1.7.2.js"></script>
<script src="script/jquery-ui-1.8.20.custom.min.js"></script>
<script src="script/underscore-min.js"></script>
<script src="script/history.js"></script>
<body>
<div id="controls">
    <div id="slider"></div>
    <div id="year"></div>
</div>
<script>

    var margin = {top:0, right:0, bottom:0, left:0},
            width = $(document).width(),
            height = $(document).height();

    var projection = d3.geo.mercator()
            .scale(width)
            .translate([width / 2, height / 2]);

    var path = d3.geo.path()
            .projection(projection);

    var zoom = d3.behavior.zoom()
            .translate(projection.translate())
            .scale(projection.scale())
            .scaleExtent([height, 50 * height])
            .on("zoom", move);

    var svg = d3.select("body").append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
            .call(zoom);

    var g = svg.append("g"),
            feature = g.selectAll(".feature"),
            area = g.selectAll(".area");

    svg.append("rect")
            .attr("class", "frame")
            .attr("width", width)
            .attr("height", height);

    d3.json("json/world-countries.json", function (collection) {
        feature = feature
                .data(collection.features)
                .enter().append("path")
                .attr("class", "feature")
                .attr("d", path);
    });

    var events;
    d3.json("json/areas-of-interest.json", function (collection) {
        events = collection;
    });

    var points_of_interest;
    d3.json("json/points-of-interest.json", function(collection) {
        points_of_interest = collection;
    });

    function move() {
        projection.translate(d3.event.translate).scale(d3.event.scale);
        feature.attr("d", path);
        g.selectAll(".point")
                .attr("cx", function(x) {return projection(x.location)[0]})
                .attr("cy", function(x) {return projection(x.location)[1]});
    }

    function plot(year) {
        var toPlot = _.filter(events.features, function (feature) {
            return feature.properties['year'] == year
        });
        area = g.selectAll(".area").data(toPlot).attr("d", path);
        area.enter().append("path")
                .attr("class", "feature area")
                .attr("d", path);
        area.exit().remove();

        //Draw the points of interest
        var points = g.selectAll(".point").data(points_of_interest.points)
                        .attr("cx", function(x) {return projection(x.location)[0]})
                        .attr("cy", function(x) {return projection(x.location)[1]});
        points.enter().append("circle")
                .attr("cx", function(x) {return projection(x.location)[0]})
                .attr("cy", function(x) {return projection(x.location)[1]})
                .attr("r", 5)
                .attr("class", "point feature");
        points.exit().remove();

        //Refresh the feature items to include the newly added ones
        feature = g.selectAll(".feature");
    }

    //Year label
    function updateYearLabel(label) {
        $("#year").html(label);
    }

    $(function () {
        // Slider
        $('#slider').slider({
            value:0,
            min:1000,
            max:2000,
            step:50,
            slide:function (event, ui) {
                plot(ui.value);
                updateYearLabel(ui.value);
            }
        });
        $('#slider').attr("style", "width:" + (width - 70) + "px");
    });


</script>
</body>