<!DOCTYPE html>
<meta charset="utf-8">
<link type="text/css" rel="stylesheet" href="style/general.css"/>
<link type="text/css" href="style/jquery-ui-1.8.20.custom.css" rel="stylesheet"/>
<script src="script/d3.v2.js"></script>
<script src="script/jquery-1.7.2.js"></script>
<script src="script/jquery-ui-1.8.20.custom.min.js"></script>
<script src="script/underscore-min.js"></script>
<script src="script/history.js"></script>
<body>
<div id="controls">
    <div id="slider"></div>
</div>
<script>

    var margin = {top:0, right:0, bottom:0, left:0},
            width = $(document).width(),
            height = $(document).height(),
            currentZoomLevel = 0;

    var projection = d3.geo.mercator()
            .scale(width)
            .translate([width / 2, height / 2]);

    var path = d3.geo.path()
            .projection(projection);

    var zoom = d3.behavior.zoom()
            .translate(projection.translate())
            .scale(projection.scale())
            .scaleExtent([height, 50 * height])
            .on("zoom", panAndZoom);

    var svg = d3.select("body").append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom);

    var g = svg.append("g").call(zoom),
            feature = g.selectAll(".feature"),
            area = g.selectAll(".area");

    g.append("rect")
            .attr("class", "frame")
            .attr("width", width)
            .attr("height", height);

    d3.json("json/world-countries.json", function (collection) {
        g.selectAll("path")
                .data(collection.features)
                .enter().append("path")
                .attr("class", "feature")
                .attr("d", path);
    });

    var areas_of_interest;
    d3.json("json/areas-of-interest.json", function (collection) {
        areas_of_interest = collection;
    });

    var points_of_interest;
    d3.json("json/points-of-interest.json", function (collection) {
        points_of_interest = collection;
    });

    function panAndZoom() {
        currentZoomLevel = getZoomIndex(d3.event.scale,zoom.scaleExtent());
        projection.translate(d3.event.translate).scale(d3.event.scale);
        g.selectAll("path").attr("d", path);
        g.selectAll(".point").attr("transform", iconPosition)
                .attr("d", iconPath);
        plotPointsOfInterest(currentYear, currentZoomLevel);
    }

    function getZoomIndex(currentScale, scaleExtent) {
        var zoomLevels = 3;
        var range = scaleExtent[1] - scaleExtent[0];
        return Math.round(currentScale * zoomLevels/ range);
    }

    function iconPath(data, index) {
        return data.drawing;
    }

    function iconPosition(data, index) {
        return "translate(" + projection(data.location).toString() + ")";
    }

    function plotAreasOfInterest(currentYear) {
        var toPlot = _.filter(areas_of_interest.features, function (feature) {
            return feature.properties['year'] == currentYear
        });
        area = g.selectAll(".area").data(toPlot).attr("d", path);
        area.enter().append("path")
                .attr("class", "area")
                .attr("d", path);
        area.exit().remove();
    }

    //Draw points of interest
    function plotPointsOfInterest(currentYear, zoomLevel) {
        console.log("zoom level: " + zoomLevel);
        var pointsToPlot = _.filter(points_of_interest.points, function (point) {
            return ((point['year'] == currentYear) && (point['zoomLevel'] == zoomLevel))
        });
        var points = g.selectAll(".point").data(pointsToPlot);
        points.attr("d", iconPath)
                .attr("transform", iconPosition);
        points.enter().append("path")
                .attr("class", "point")
                .attr("d", iconPath)
                .attr("transform", iconPosition);
        points.exit().remove();
        d3.selectAll(".point").on("click", function (d, i) {
            $("#text_container").show();
        })
    }

    //Year label
    function updateYearLabel(label) {
        $(".ui-slider-handle").html("<p>" + label + "</p>");
    }

    $(function () {
        // Slider
        $('#slider').slider({
            value:0,
            min:1000,
            max:2000,
            slide:function (event, ui) {
                currentYear = Math.round(ui.value / 50) * 50;
                plotAreasOfInterest(currentYear);
                plotPointsOfInterest(currentYear, currentZoomLevel);
                updateYearLabel(ui.value);
            }
        });
        $('#slider').attr("style", "width:" + (width - 100) + "px");
    });

    $(".close").live("click", function () {
        $("#text_container").hide();
    });

</script>
<div id="text_container">
    <div>
        <img class="close" src="image/close.png"/>
        Content goes here
    </div>
</div>
</body>