<!DOCTYPE html>
<meta charset="utf-8">
<link type="text/css" rel="stylesheet" href="style/general.css"/>
<link type="text/css" href="style/jquery-ui-1.8.20.custom.css" rel="stylesheet"/>
<script src="script/d3.v2.js"></script>
<script src="script/jquery-1.7.2.js"></script>
<script src="script/jquery-ui-1.8.20.custom.min.js"></script>
<script src="script/underscore-min.js"></script>
<script src="script/history.js"></script>
<body>
<div id="controls">
    <div id="slider"></div>
</div>
<script>

    var margin = {top:0, right:0, bottom:0, left:0},
            width = $(document).width(),
            height = $(document).height(),
            currentZoomLevel = 0;

    var projection = d3.geo.mercator()
            .scale(width)
            .translate([width / 2, height / 2]);

    var path = d3.geo.path()
            .projection(projection);

    var zoomLevels = 3;
    var zoom = d3.behavior.zoom()
            .translate(projection.translate())
            .scale(projection.scale())
            .scaleExtent([height, 50 * height])
            .on("zoom", panAndZoom);
    var zoomRange = zoom.scaleExtent()[1] - zoom.scaleExtent()[0];

    var svg = d3.select("body").append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom);

    var g = svg.append("g").call(zoom),
            areasG = g.append("g"),
            pointsG = g.append("g"),
            feature = g.selectAll(".feature"),
            area = g.selectAll(".area");

    d3.json("json/world-countries.json", function (collection) {
        areasG.selectAll("path")
                .data(collection.features)
                .enter().append("path")
                .attr("class", "feature")
                .attr("d", path);
    });

    var areas_of_interest;
    d3.json("json/areas-of-interest.json", function (collection) {
        areas_of_interest = collection;
    });

    var points_of_interest;
    d3.json("json/points-of-interest.json", function (collection) {
        points_of_interest = collection;
    });

    var details;
    d3.json("json/details.json", function (collection) {
        details = collection;
    });

    function panAndZoom() {
        currentZoomLevel = getZoomIndex(d3.event.scale);
//        console.log("translate: " + d3.event.translate + " zoom: " + d3.event.scale);
        projection.translate(d3.event.translate).scale(d3.event.scale);
        g.selectAll("path").attr("d", path);
        g.selectAll(".point").attr("transform", iconPosition).attr("d", iconPath);
//        g.attr("transform", "scale(" + projection.scale() + ")translate(" + projection.translate() + ")" );

        plotPointsOfInterest(currentYear, currentZoomLevel);
    }

    function getZoomIndex(currentScale) {
        return Math.round(currentScale * zoomLevels/ zoomRange);
    }

    function getScale(currentZoomIndex) {
        return currentZoomIndex * zoomRange / zoomLevels;
    }

    function iconPath(data, index) {
        return data.drawing;
    }

    function iconPosition(data, index) {
        return "translate(" + projection(data.location).toString() + ")";
    }

    function plotAreasOfInterest(currentYear) {
        var toPlot = _.filter(areas_of_interest.features, function (feature) {
            var yearInput = feature.properties['year'];
            if(yearInput.indexOf("-") != -1) {
                var yearRange = yearInput.split("-").sort();
                return  (currentYear >= yearRange[0]) && (currentYear <= yearRange[1]);
            } else {
                return currentYear == yearInput;
            }
        });
        area = areasG.selectAll(".area").data(toPlot);
        area.enter()
                .append("path")
                .attr("class", "area")
                .attr("d", path);
        area.attr("d", path);
        area.exit().remove();
    }

    //Draw points of interest
    function plotPointsOfInterest(currentYear, zoomLevel) {
        var svgIconsToPlot = _.filter(points_of_interest.points, function (point) {
            return ((point['year'] == currentYear) && (point['zoomLevel'] == zoomLevel)) && point["drawing"]
        });
        plotSVGIcons(svgIconsToPlot);
        var imagesToPlot = _.filter(points_of_interest.points, function (point) {
            return ((point['year'] == currentYear) && (point['zoomLevel'] == zoomLevel)) && point["image"]
        });
        plotImages(imagesToPlot);
    }

    function plotSVGIcons(iconsJson) {
        var points = pointsG.selectAll(".point").data(iconsJson);
        points.enter().append("path")
                .attr("class", "point")
                .attr("d", iconPath)
                .attr("transform", iconPosition);
        points.attr("d", iconPath)
                .attr("transform", iconPosition)
                .attr("d", iconPath);
        points.exit().remove();
        d3.selectAll(".point").on("click", function (d, i) {
                //showDescription();
        });
    }

    function plotImages(imagesJson) {
        var images = pointsG.selectAll("image").data(imagesJson);
        images.enter().append("image")
                .attr("xlink:href", function(d){return d.image})
                .attr("x", function(d) { return projection(d.location)[0] })
                .attr("y", function(d) { return projection(d.location)[1] })
                .attr("width", function(d) { return d.width })
                .attr("height", function(d) { return d.height })
                .on("click", showDescription);
        images.attr("xlink:href", function(d){return d.image})
                .attr("x", function(d) { return projection(d.location)[0] })
                .attr("y", function(d) { return projection(d.location)[1] })
                .attr("width", function(d) { return d.width })
                .attr("height", function(d) { return d.height })
                .on("click", showDescription);
        images.exit().remove();
//        d3.selectAll("image").on("click", function (d, i) {
//            showDescription();
//        });
        var titles = pointsG.selectAll("text").data(imagesJson);
        titles.enter().append("text")
                .attr("x", function(d) { return projection(d.location)[0] })
                .attr("y", function(d) { return projection(d.location)[1] })
                .text(function(d) { return d.title });
        titles.attr("x", function(d) { return projection(d.location)[0] })
                .attr("y", function(d) { return projection(d.location)[1] })
                .text(function(d) { return d.title });
        titles.exit().remove();
    }

    function showDescription(data) {
        console.log("sdf");
        $("#text_container div").html(details[data.detailsId]);
        $("#text_container").show();
    }

    function warp(location, zoomLevel) {
        g.selectAll(".feature").attr("transform", "scale(" + getScale(zoomLevel, zoom.scaleExtent) + ")translate(" + projection(location) + ")" );
    }

    //Year label
    function updateYearLabel(label) {
        $(".ui-slider-handle").html("<p>" + label + "</p>");
    }

    $(function () {
        // Slider
        $('#slider').slider({
            value:0,
            min:230,
            max:330,
            slide:function (event, ui) {
                currentYear = 230 + 330 - round(ui.value);
                plotAreasOfInterest(currentYear);
                plotPointsOfInterest(currentYear, currentZoomLevel);
                updateYearLabel(currentYear + "B.C");
            }
        });
        $('#slider').attr("style", "width:" + (width - 100) + "px");

    });

    function round(value) {
        return Math.round(value / 5) * 5
    }

    $(".close").live("click", function () {
        $("#text_container").hide();
    });

    //Enable mapping
    var mappingMode = true;
    var currentPath = [];
    $(function() {
        if(mappingMode) {
            $('svg').click(function(event) {
                var xy = [event.clientX, event.clientY];
                $('#drawing').append("["+projection.invert(xy)+"],");
                currentPath.push(projection.invert(xy));
                var pathToDraw = [{"type":"Feature", "geometry":{"type":"Polygon","coordinates": [currentPath]}}]
                $(".plotting").remove();
                svg.selectAll(".drawing").data(pathToDraw)
                        .enter()
                        .append("path")
                        .attr("class", "plotting")
                        .attr("d",path);
            });
            $('#clear').click(function() {
                currentPath = [];
                $("#drawing").html("");
                $(".plotting").remove();
            })
        } else {
            $("#editor").remove();
        }
    });


</script>
<div id="text_container">
    <img class="close" src="image/close.png"/>
    <div>
        ...
    </div>
</div>
<div id="editor">
    <p id="drawing"></p>
    <input type="button" value="clear" id="clear"/>
</div>
</body>